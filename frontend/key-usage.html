<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Key Usage - Zerokey</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacOSystemFont, sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: #f9fafb;
        color: #111827;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      h1 {
        color: #1e40af;
        margin-bottom: 0.25rem;
      }
      .subtitle {
        color: #374151;
        margin-bottom: 1.5rem;
      }
      .section {
        background: #fff;
        padding: 1.25rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 1.25rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 0.6rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      th {
        background: #f3f4f6;
        font-weight: 600;
      }
      .back {
        margin-bottom: 1rem;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 8px;
        cursor: pointer;
      }
      button:hover {
        background: #1d4ed8;
      }
      #status {
        margin-top: 0.5rem;
        color: #6b7280;
      }
      .error {
        color: #dc2626;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button class="back" onclick="history.back()">‚Üê Back</button>
      <h1 id="title">API Key Usage</h1>
      <div class="subtitle" id="subtitle"></div>

      <div class="section">
        <h2>Usage over Time</h2>
        <canvas id="usageChart" height="120"></canvas>
        <p id="status">Loading usage...</p>
      </div>

      <div class="section">
        <h2>Recent Calls (Last 2)</h2>
        <table>
          <thead>
            <tr>
              <th>When</th>
              <th>Provider</th>
              <th>Model/Endpoint</th>
              <th>Status</th>
              <th>Latency (ms)</th>
              <th>Tokens</th>
            </tr>
          </thead>
          <tbody id="usageTable"></tbody>
        </table>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const keyId = params.get("keyId");
      const keyName = params.get("name") || "";
      const token = localStorage.getItem("access_token");
      const statusEl = document.getElementById("status");

      if (!token) {
        window.location.href = "/static/index.html";
      }

      document.getElementById("title").textContent = `Usage for ${keyName || "API Key"}`;
      document.getElementById("subtitle").textContent = `Key ID: ${keyId}`;

      async function loadUsage() {
        if (!keyId) {
          statusEl.className = "error";
          statusEl.textContent = "Missing keyId";
          return;
        }

        statusEl.textContent = "Loading usage...";
        statusEl.className = "";

        try {
          const res = await fetch(`/usage/${keyId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          if (!res.ok) {
            throw new Error(await res.text());
          }
          const data = await res.json();
          renderUsage(data.logs);
          statusEl.textContent = data.logs.length ? "" : "No usage yet for this key.";
        } catch (err) {
          statusEl.className = "error";
          statusEl.textContent = "Error: " + err.message;
        }
      }

      function renderUsage(logs) {
        const tableBody = document.getElementById("usageTable");
        tableBody.innerHTML = "";
        
        // Show only last 2 calls in the table
        const recentLogs = logs.slice(-2).reverse();
        
        recentLogs.forEach((log) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${new Date(log.created_at).toLocaleString()}</td>
            <td>${log.provider}</td>
            <td>${log.model || "-"}</td>
            <td>${log.status || "-"}</td>
            <td>${log.latency_ms ?? "-"}</td>
            <td>${log.total_tokens ?? 0}</td>
          `;
          tableBody.appendChild(tr);
        });

        // Chart uses all data
        const labels = logs.map((log) => new Date(log.created_at).toLocaleTimeString());
        const tokens = logs.map((log) => log.total_tokens || 0);

        const ctx = document.getElementById("usageChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Total tokens",
                data: tokens,
                borderColor: "#2563eb",
                backgroundColor: "rgba(37, 99, 235, 0.2)",
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      }

      loadUsage();
    </script>
  </body>
</html>
